---
title:  SQLServer性能分析及优化
date:   2017-09-05 15:00:00 +0800
categories:
- 数据库
tags:
- SQLServer
- 性能优化
---

公司使用SQLServer作为数据库，工作中积累了很多SQL性能优化经验，为了自己查询和记忆方便，我的分类方式主要分为语法优化，子句优化和索引优化，可以根据自己所需直接查找到对应的优化建议。（比如使用!=好还是<>好，LIKE语句有什么优化建议...）

需要注意的是：有些优化技巧是只能在SQLServer中使用，但更多的是标准SQL能够通用的优化技巧。




## 子句优化

SQL优化建议很多且难以分类，所以我以`子句为粒度`来对SQL优化建议进行分类，尽可能让我们看到子句就知道需要其对应的优化建议。这里为了理解方便，将SQL所有子句根据where子句的位置分割为前缀子句和后缀子句，where子句属于后缀子句。

#### 前缀子句

###### SELECT

* `避免使用SELECT * 的语法`：应该完整的写上所需要的字段，并且要按照表中字段的物理顺序书写，不但可以防止表结构改变导致的代码错误，也可以防止大数据量的提取导致SQL效率低下。

###### INSERT

* `避免使用INSERT INTO table VALUE(?,?,?)`：需要在table后完整地写上需要插入的字段，按照字段的物理顺序书写，而不是用?代替，这样可以提高效率。

###### UPDATE

* 暂无

###### DISTINCT

* `尽量少用DISTINCT或用其他方法去重`：DISTINCT解决重复数据很方便，但是他会临时产生一张工作表，通过排序来删除重复的数据，因此会增加SQL的I/O次数和时间损耗。


###### COUNT

* `COUNT统计NULL有差异`：COUNT(\*)和COUNT(1)会统计NULL值，COUNT(列名)不会统计NULL值
* `尽可能使用COUNT(1)`：[官方文档显示1等价于*](https://stackoverflow.com/questions/1221559/count-vs-count1?answertab=active#tab-top)，因为大家都传言1快过*，所以官方对1做了优化，虽说等价，但还是推荐使用COUNT(1)，保证统一。
* `单列索引可以提升COUNT性能`：COUNT(\*)和COUNT(1)都会自动遍历寻找最小的索引，考虑在一个最短的列建立一个单列索引，会极大的提升性能。




#### 后缀子句


###### OR

* `尽可能少用`： 会引起全表扫描（不符合SARG），可以考虑用UNION替换。

###### LIKE

* `[通配符](*,?,_,%)不要在字符串的开头`：会导致索引失效而全表扫描（不符合SARG）

###### IN / NOT IN

* `尽可能少用`： 会引起全表扫描（不符合SARG），类似OR，可以考虑用EXISTS替换。

###### EXISTS

* ​

###### WHERE

* ​





## 语法优化

* `避免使用子查询，使用连接查询`：子查询属于笛卡尔集，嵌套过多会导致数据量指数级增长，如果不能避免希望能够先过滤尽可能多的数据。
* `数据表起别名`：可以利于优化器优化。
* `不要使用负逻辑`：




## 索引优化



